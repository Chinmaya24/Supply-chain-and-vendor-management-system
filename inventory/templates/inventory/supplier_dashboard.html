{% extends 'inventory/base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Dashboard Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Supplier Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-300 mt-2">Manage inventory with custom units</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a href="{% url 'supplier_orders' %}" class="btn btn-primary gap-2">
                <i class="fas fa-clipboard-list"></i> Orders
            </a>
            <a href="{% url 'supplier_ratings' %}" class="btn btn-info gap-2">
                <i class="fas fa-star"></i> Ratings
            </a>
            <a href="{% url 'forecast' %}" class="btn btn-secondary gap-2">
                <i class="fas fa-chart-line"></i> Forecast
            </a>
        </div>
    </div>

    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="alert alert-success shadow-lg animate-fade-in">
            <div><i class="fas fa-check-circle"></i><span>{{ message }}</span></div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Add New Commodity Card -->
    <div class="card bg-base-100 shadow-lg mb-8">
        <div class="card-body">
            <h2 class="card-title text-xl">Add New Commodity</h2>
            <form method="POST" action="{% url 'add_commodity' %}" class="space-y-4">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Commodity</span></label>
                        <select name="commodity" class="select select-bordered w-full">
                            {% for commodity in commodities %}
                            <option value="{{ commodity.id }}">{{ commodity.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Unit</span></label>
                        <select name="unit" class="select select-bordered w-full">
                            <option value="kg">Kilogram (kg)</option>
                            <option value="g">Gram (g)</option>
                            <option value="q">Quintal (q)</option>
                            <option value="t">Ton (t)</option>
                            <option value="m">Metre (m)</option>
                            <option value="cm">Centimetre (cm)</option>
                            <option value="in">Inch (in)</option>
                            <option value="ft">Foot (ft)</option>
                            <option value="unit" selected>Unit</option>
                            <option value="l">Litre (l)</option>
                            <option value="ml">Millilitre (ml)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Price Per Unit</span></label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">₹</span>
                            <input type="number" name="price_per_unit" class="input input-bordered w-full pl-8" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Manufacturer</span></label>
                        <input type="text" name="manufactured_company" class="input input-bordered w-full" required>
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-medium">Available Quantity</span></label>
                        <input type="number" name="available_units" class="input input-bordered w-full" step="0.01" required>
                    </div>
                </div>
                
                <div class="card-actions justify-end mt-6">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle mr-2"></i> Add Commodity
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <div class="flex justify-between items-center mb-6">
                <h2 class="card-title text-xl">Your Inventory</h2>
                <div class="form-control">
                    <div class="input-group">
                        <input type="text" placeholder="Search..." class="input input-bordered" id="inventorySearch">
                        <button class="btn btn-square"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Commodity</th>
                            <th>Manufacturer</th>
                            <th>Price/Unit</th>
                            <th>Available</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventory %}
                        <tr>
                            <td>
                                <div class="flex items-center space-x-3">
                                    <div class="avatar placeholder">
                                        <div class="bg-neutral text-neutral-content rounded-full w-8">
                                            <span>{{ item.commodity.name|first|upper }}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-bold">{{ item.commodity.name }}</div>
                                        <div class="text-sm opacity-50">ID: {{ item.id }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>{{ item.manufactured_company }}</td>
                            <td>
                                <div class="font-medium">
                                    ₹{{ item.price_per_unit|floatformat:2 }}
                                    <span class="text-xs text-gray-500">/{{ item.unit }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="badge badge-outline {% if item.available_units < 10 %}badge-error{% elif item.available_units < 50 %}badge-warning{% else %}badge-success{% endif %}">
                                    {{ item.available_units|floatformat:2 }} {{ item.get_unit_display }}
                                </div>
                            </td>
                            <td class="text-right">
                                <div class="flex space-x-2 justify-end">
                                    <button onclick="openModal('{{ item.id }}', '{{ item.available_units }}', '{{ item.price_per_unit }}', '{{ item.manufactured_company }}', '{{ item.unit }}')"
                                        class="btn btn-sm btn-outline btn-warning">
                                        <i class="fas fa-edit mr-1"></i> Edit
                                    </button>
                                    <a href="{% url 'delete_commodity' item.id %}" class="btn btn-sm btn-outline btn-error" onclick="return confirm('Are you sure?')">
                                        <i class="fas fa-trash-alt mr-1"></i> Delete
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">
                                <i class="fas fa-box-open text-3xl mb-2"></i>
                                <p>No inventory items found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if inventory.has_other_pages %}
            <div class="flex justify-center mt-6">
                <div class="btn-group">
                    {% if inventory.has_previous %}
                    <a href="?page={{ inventory.previous_page_number }}" class="btn">«</a>
                    {% endif %}
                    {% for i in inventory.paginator.page_range %}
                    <a href="?page={{ i }}" class="btn {% if inventory.number == i %}btn-active{% endif %}">{{ i }}</a>
                    {% endfor %}
                    {% if inventory.has_next %}
                    <a href="?page={{ inventory.next_page_number }}" class="btn">»</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Update Modal -->
<div id="updateModal" class="modal">
    <div class="modal-box">
        <button onclick="closeModal()" class="btn btn-sm btn-circle absolute right-2 top-2">✕</button>
        <h3 class="font-bold text-lg mb-4">Update Commodity</h3>
        <form id="updateForm" method="POST">
            {% csrf_token %}
            <input type="hidden" name="commodity_id" id="commodity_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label"><span class="label-text">Price Per Unit</span></label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">₹</span>
                        <input type="number" name="price_per_unit" id="price" class="input input-bordered w-full pl-8" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label"><span class="label-text">Unit</span></label>
                    <select name="unit" id="unitSelect" class="select select-bordered w-full">
                        <option value="kg">Kilogram (kg)</option>
                        <option value="g">Gram (g)</option>
                        <option value="q">Quintal (q)</option>
                        <option value="t">Ton (t)</option>
                        <option value="m">Metre (m)</option>
                        <option value="cm">Centimetre (cm)</option>
                        <option value="in">Inch (in)</option>
                        <option value="ft">Foot (ft)</option>
                        <option value="unit">Unit</option>
                        <option value="l">Litre (l)</option>
                        <option value="ml">Millilitre (ml)</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="form-control">
                    <label class="label"><span class="label-text">Manufacturer</span></label>
                    <input type="text" name="manufactured_company" id="manufacturer" class="input input-bordered w-full" required>
                </div>
                
                <div class="form-control">
                    <label class="label"><span class="label-text">Available Quantity</span></label>
                    <input type="number" name="available_units" id="units" class="input input-bordered w-full" step="0.01" required>
                </div>
            </div>
            
            <div class="modal-action">
                <button type="button" onclick="closeModal()" class="btn btn-ghost">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Modal functions
    function openModal(id, units, price, manufacturer, unit) {
        document.getElementById("commodity_id").value = id;
        document.getElementById("units").value = units;
        document.getElementById("price").value = price;
        document.getElementById("manufacturer").value = manufacturer;
        document.getElementById("unitSelect").value = unit;

        const form = document.getElementById("updateForm");
        form.action = `/dashboard/supplier/update/${id}/`;
        document.getElementById("updateModal").classList.add("modal-open");
    }

    function closeModal() {
        document.getElementById("updateModal").classList.remove("modal-open");
    }

    // Search functionality
    document.getElementById("inventorySearch").addEventListener("input", function() {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll("tbody tr");
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchValue) ? "" : "none";
        });
    });
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>
{% endblock %}